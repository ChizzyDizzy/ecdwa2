# Network Policies for CloudRetail Platform
# These policies implement zero-trust security model
# Restricting traffic between services to only necessary connections

---
# Default Deny All Ingress Traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: cloudretail
  labels:
    app: cloudretail
    component: security
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Default Deny All Egress Traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: cloudretail
  labels:
    app: cloudretail
    component: security
spec:
  podSelector: {}
  policyTypes:
  - Egress

---
# API Gateway Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-network-policy
  namespace: cloudretail
  labels:
    app: api-gateway
    component: security
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from anywhere (public-facing)
  - from:
    - podSelector: {}
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow egress to all microservices
  - to:
    - podSelector:
        matchLabels:
          component: microservice
    ports:
    - protocol: TCP
      port: 3001  # User Service
    - protocol: TCP
      port: 3002  # Product Service
    - protocol: TCP
      port: 3003  # Order Service
    - protocol: TCP
      port: 3004  # Inventory Service
    - protocol: TCP
      port: 3005  # Payment Service
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# User Service Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: user-service-network-policy
  namespace: cloudretail
  labels:
    app: user-service
    component: security
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from API Gateway only
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 3001
  egress:
  # Allow egress to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
          service: user-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Event Bus
  - to:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 4000
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Product Service Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: product-service-network-policy
  namespace: cloudretail
  labels:
    app: product-service
    component: security
spec:
  podSelector:
    matchLabels:
      app: product-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from API Gateway and Order Service
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 3002
  egress:
  # Allow egress to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
          service: product-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Event Bus
  - to:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 4000
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Order Service Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-service-network-policy
  namespace: cloudretail
  labels:
    app: order-service
    component: security
spec:
  podSelector:
    matchLabels:
      app: order-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from API Gateway and Payment Service
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: payment-service
    ports:
    - protocol: TCP
      port: 3003
  egress:
  # Allow egress to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
          service: order-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Event Bus
  - to:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 4000
  # Allow egress to Inventory and Payment services
  - to:
    - podSelector:
        matchLabels:
          app: inventory-service
    ports:
    - protocol: TCP
      port: 3004
  - to:
    - podSelector:
        matchLabels:
          app: payment-service
    ports:
    - protocol: TCP
      port: 3005
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Inventory Service Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: inventory-service-network-policy
  namespace: cloudretail
  labels:
    app: inventory-service
    component: security
spec:
  podSelector:
    matchLabels:
      app: inventory-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from API Gateway and Order Service
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 3004
  egress:
  # Allow egress to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
          service: inventory-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Event Bus
  - to:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 4000
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Payment Service Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-service-network-policy
  namespace: cloudretail
  labels:
    app: payment-service
    component: security
spec:
  podSelector:
    matchLabels:
      app: payment-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from API Gateway and Order Service
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 3005
  egress:
  # Allow egress to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
          service: payment-service
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Event Bus
  - to:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 4000
  # Allow egress to Order Service
  - to:
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 3003
  # Allow egress to external payment gateways (Internet)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443  # HTTPS for Stripe, PayPal, etc.
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Event Bus Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: event-bus-network-policy
  namespace: cloudretail
  labels:
    app: event-bus
    component: security
spec:
  podSelector:
    matchLabels:
      app: event-bus
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from all microservices
  - from:
    - podSelector:
        matchLabels:
          component: microservice
    ports:
    - protocol: TCP
      port: 4000
  egress:
  # Allow egress to Kafka
  - to:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 9092
  # Allow egress to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# PostgreSQL Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: cloudretail
  labels:
    app: postgres
    component: security
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Allow ingress from corresponding microservices only
  - from:
    - podSelector:
        matchLabels:
          component: microservice
    ports:
    - protocol: TCP
      port: 5432

---
# Redis Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-network-policy
  namespace: cloudretail
  labels:
    app: redis
    component: security
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  # Allow ingress from Event Bus only
  - from:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 6379

---
# Kafka Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka-network-policy
  namespace: cloudretail
  labels:
    app: kafka
    component: security
spec:
  podSelector:
    matchLabels:
      app: kafka
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from Event Bus
  - from:
    - podSelector:
        matchLabels:
          app: event-bus
    ports:
    - protocol: TCP
      port: 9092
  # Allow ingress from other Kafka pods (cluster communication)
  - from:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 9092
    - protocol: TCP
      port: 9093
  egress:
  # Allow egress to Zookeeper
  - to:
    - podSelector:
        matchLabels:
          app: zookeeper
    ports:
    - protocol: TCP
      port: 2181
  # Allow egress to other Kafka pods
  - to:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 9092
    - protocol: TCP
      port: 9093
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Zookeeper Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: zookeeper-network-policy
  namespace: cloudretail
  labels:
    app: zookeeper
    component: security
spec:
  podSelector:
    matchLabels:
      app: zookeeper
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from Kafka
  - from:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 2181
  # Allow ingress from other Zookeeper pods (cluster communication)
  - from:
    - podSelector:
        matchLabels:
          app: zookeeper
    ports:
    - protocol: TCP
      port: 2181
    - protocol: TCP
      port: 2888
    - protocol: TCP
      port: 3888
  egress:
  # Allow egress to other Zookeeper pods
  - to:
    - podSelector:
        matchLabels:
          app: zookeeper
    ports:
    - protocol: TCP
      port: 2181
    - protocol: TCP
      port: 2888
    - protocol: TCP
      port: 3888
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Allow monitoring/metrics collection
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: cloudretail
  labels:
    app: cloudretail
    component: monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  # Allow Prometheus to scrape metrics from all pods
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9090
